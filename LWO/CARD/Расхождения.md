### расхождения по платежам в POS-ах 
```sql
WITH bri AS (
SELECT*
FROM (
    SELECT
        p_dimension.getdimcode(p_common.to_num(p_common.getdocattr(a.parent_id, 'Наименование'))) as contr_code,
        id, num_doc, status, date_doc, term_id, 
        max(dateel) as dateel, 
        summ, bri_ref_nr, bri_appr_code, 
        emboss_num, 
        regexp_replace(emboss_num, '\*+', '%') as emboss_mask,
        req_id,
        sum(decode(status, 'OK', 0, 1))over(partition by term_id, date_doc, summ, substr(emboss_num, 1,6)) as gr_cnt
    FROM (
        select  /*+ index(el DOC_ID)*/
                a.id, 
                a.parent_id,
                num_doc,
                status,
                a.date_doc,
                term_id,
                nvl(MAX(case when elementtype_id = 17223 then el.dateel else NULL end), a.dateel) as dateel,
                p_common.to_num(MAX(case when elementtype_id = 4494 then value else NULL end))*100 as  summ,
                MAX(case when elementtype_id = 21093 then value else NULL end) as bri_ref_nr,
                MAX(case when elementtype_id = 21094 then value else NULL end) as bri_appr_code,
                MAX(case when elementtype_id = 5210 then value else NULL end) as emboss_num,
                MAX(case when elementtype_id = 4670 then value else NULL end) as oper_type,
                --regexp_replace(MAX(case when elementtype_id = 5210 then value else NULL end), '\*+','%') as emboss_mask,
                MAX(case when elementtype_id = 5182 then value else NULL end) as req_id
        from (
            select /*+ full(el) parallel(el 4)*/
                /*+ index(el DOC_ID)*/ 
                d.id, d.parent_id, num_doc, status, d.date_doc, dateel,  value as term_id
            from element el, doc d
            where el.elementtype_id = 4711
            and d.users_id not in ( 34495, 143363, 3456, 40995, 148106, 135983, 7189)-- не SMS, не технологический ЕРИП, не ВОБ, не МБ, не ИБ, не ОПЛАТИ, не банкоматы и не велкомовские терминалы
    --        and el.doc_id = 4518131110 --TEST
           -- and status = 'OK'
            and  el.doc_id = d.id
            and el.date_doc between :date_start and :date_end
          --  and d.id in (4519150840, 4519152298)
            )a, element el
        WHERE el.doc_id = a.id
        and el.elementtype_id in (
                                        4494, --Сумма
    --                                    4711, -- терминал
                                        5210,-- CardEmbossNum.
                                        5182, -- Идентификатор запроса.
                                        21093, -- RRN..
                                        21094, -- AuthCode..
                                        4670   -- Тип операции.
                                )
        AND rownum > 0
        GROUP BY a.id, a.parent_id, a.num_doc, status, a.date_doc, a.dateel,  a.term_id
        ) a
    WHERE oper_type = '2'
    GROUP BY id, a.parent_id, num_doc, status, date_doc, term_id, summ, bri_ref_nr, bri_appr_code, emboss_num, req_id
    )
WHERE gr_cnt > 0
)

, base AS (
    SELECT aa.*
    FROM (
        SELECT a.*,
            MAX(decode(a.status, 'OK', 1, 0))over(partition by mpcs_id) as has_ok
        FROM (
            select /*+ LEADING(m) index(m TRANSACTION_DATE) DRIVING_SITE(m)*/
                bri.*, '>><<', m.id as mpcs_id, m.tr_date, emboss_number, fld_098, ref_nr, appr_code, revers_id, hand_reversals

            from bri
            LEFT JOIN mpcs_slips@bars m
            ON m.tr_date between :date_start and :date_end+1
            AND m.term_id = bri.term_id
            AND trunc(m.tr_date) = bri.date_doc
            AND CASE 
                    WHEN  bri_ref_nr IS NOT NULL AND  bri_appr_code = m.appr_code THEN 1 -- по ref_nr И appr_code
                    WHEN bri_ref_nr IS NULL AND m.amount = bri.summ AND m.emboss_number like bri.emboss_mask AND ABS(m.tr_date - bri.dateel)*86400 < 120 THEN 1
                    ELSE 0
                END =1
            and trunc(msg_type/100) != 14
            )a

        )aa
    WHERE CASE 
            WHEN  status != 'OK' AND mpcs_id IS NULL THEN 0
            WHEN has_ok = 1 THEN 0
            ELSE 1
          END = 1
        AND rownum > 0
--    order by term_id, dateel
)

, reversals AS (
select /*+ index(rev MPCS_SLIPS_ID) DRIVING_SITE(rev)*/ base.mpcs_id, 
    rev.id as rev_id,
    rev.ref_nr as rev_ref_nr,
    rev.appr_code as rev_appr_code
from base, mpcs_slips@bars rev
WHERE base.revers_id IS NOT NULL 
and rev.id = base.revers_id
AND trunc(rev.msg_type/100) = 14

UNION 

select /*+ index(rev TRANSACTION_DATE) DRIVING_SITE(rev)*/ base.mpcs_id, 
    rev.id as rev_id,
    rev.ref_nr as rev_ref_nr,
    rev.appr_code as rev_appr_code
from base, mpcs_slips@bars rev
WHERE rev.tr_date >=  :date_start 
AND trunc(rev.msg_type/100) = 14
AND base.term_id = rev.term_id
AND base.ref_nr = rev.ref_nr
AND base.appr_code = rev.appr_code
AND base.summ = rev.amount
AND rownum > 0
)

SELECT *
FROM (
    select base.*,
        r.rev_id, rev_ref_nr, rev_appr_code
    from base
    LEFT JOIN reversals r
    ON base.mpcs_id = r.mpcs_id
    )a
WHERE CASE
        WHEN STATUS != 'OK' AND a.mpcs_id IS NULL THEN 0
        WHEN STATUS != 'OK' AND a.rev_id IS NOT NULL THEN 0
        WHEN STATUS = 'OK' AND a.mpcs_id IS NOT NULL AND rev_id IS NULL THEN 0
        ELSE 1
      END = 1
```


### Расхождения по платежам в банкоматах
```sql
WITH bri AS (
SELECT*
FROM (
    select a.id, 
            num_doc,
            status,
            a.date_doc,
            term_id,
            replace(term_id, 'M', 'P') as term_id2,
            nvl(MAX(case when elementtype_id = 17223 then el.dateel else NULL end), a.dateel) as dateel,
            p_common.to_num(MAX(case when elementtype_id = 4494 then value else NULL end))*100 as  summ,
--            MAX(case when elementtype_id = 17223 then value else NULL end) as ref_nr,
            MAX(case when elementtype_id = 17224 then value else NULL end) as bri_appr_code,
            MAX(case when elementtype_id = 5210 then value else NULL end) as emboss_num,
            --regexp_replace(MAX(case when elementtype_id = 5210 then value else NULL end), '\*+','%') as emboss_mask,
            MAX(case when elementtype_id = 5182 then value else NULL end) as erip_id
    from (
        select d.id, num_doc, status, d.date_doc, dateel,  value as term_id
        from element el, doc d
        where el.elementtype_id = 4711

--        and el.doc_id = 4518131110 --TEST
        and status != 'OK'
        and d.id = el.doc_id

        and el.date_doc between :date_start and :date_end
        and el.users_id = 34495
        and el.value like 'M%'
      --  and d.id in (4519150840, 4519152298)
        )a, element el
    WHERE el.doc_id = a.id
    and el.elementtype_id in (
                                    4494, --Сумма
--                                    4711, -- терминал
                                    5210,-- CardEmbossNum.
                                    5182, -- Идентификатор запроса.
                                    17223, -- TrnRefId.
                                    17224 -- TrnAuthId.

                            )
    AND rownum > 0
    GROUP BY a.id, a.num_doc, status, a.date_doc, a.dateel,  a.term_id
    )
)

, base AS (

SELECT*
FROM (
select /*+ LEADING(m) index(m TRANSACTION_DATE) DRIVING_SITE(m)*/
bri.*, '>><<', m.id as mpcs_id, m.tr_date, emboss_number, ref_nr, appr_code, revers_id, hand_reversals
from bri
LEFT JOIN mpcs_slips@bars m
ON m.tr_date between :date_start and :date_end+1
AND m.term_id = bri.term_id2
AND bri.id = m.fld_104
and trunc(msg_type/100) != 14
)
WHERE CASE 
        WHEN  status != 'OK' AND mpcs_id IS NULL THEN 0
        ELSE 1
      END = 1
)

, reversals AS (
select /*+ index(rev MPCS_SLIPS_ID) DRIVING_SITE(rev)*/ base.mpcs_id, 
    rev.id as rev_id,
    rev.ref_nr as rev_ref_nr,
    rev.appr_code as rev_appr_code
from base, mpcs_slips@bars rev
WHERE rev.id = base.revers_id
AND  rev.tr_date >=  :date_start 
AND trunc(rev.msg_type/100) = 14

UNION 

select /*+ index(rev TRANSACTION_DATE) DRIVING_SITE(rev)*/ base.mpcs_id, 
    rev.id as rev_id,
    rev.ref_nr as rev_ref_nr,
    rev.appr_code as rev_appr_code
from base, mpcs_slips@bars rev
WHERE rev.tr_date >=  :date_start 
AND trunc(rev.msg_type/100) = 14
AND base.term_id = rev.term_id
AND base.ref_nr = rev.ref_nr
AND base.appr_code = rev.appr_code
AND base.summ = rev.amount
AND rownum > 0
)

SELECT *
FROM (
    select base.*,
        r.rev_id, rev_ref_nr, rev_appr_code
    from base
    LEFT JOIN reversals r
    ON base.mpcs_id = r.mpcs_id
    )a
WHERE CASE
        WHEN STATUS != 'OK' AND a.mpcs_id IS NULL THEN 0
        WHEN STATUS != 'OK' AND a.rev_id IS NOT NULL THEN 0
        WHEN STATUS = 'OK' AND a.mpcs_id IS NOT NULL AND rev_id IS NULL THEN 0
        ELSE 1
      END = 1
```


### Рахождения по платежам в терминалах A1
```sql
WITH bri AS (
SELECT*
FROM (
    select a.id, 
--            a.PmtRefId,
            num_doc,
            status,
            a.date_doc,
            MAX(case when elementtype_id = 5210 then dateel else NULL end) as dateel,
            to_date(substr(a.PmtRefId, -14), 'yyyymmddhh24miss') as oper_time,
            MAX(case when elementtype_id = 4494 then value else NULL end) as  summ,
            MAX(case when elementtype_id = 4711 then value else NULL end) as term_id,
            MAX(case when elementtype_id = 5210 then value else NULL end) as emboss_num,
            --regexp_replace(MAX(case when elementtype_id = 5210 then value else NULL end), '\*+','%') as emboss_mask,
            MAX(case when elementtype_id = 5182 then value else NULL end) as erip_id
    from (
        select d.id, num_doc, status, d.date_doc, value as PmtRefId
        from element el, doc d
        where el.elementtype_id = 6518

        and el.date_doc between :date_start and :date_end
        and d.id = el.doc_id
        and el.users_id = 34495
        and status != 'OK'
      --  and d.id in (4519150840, 4519152298)
        )a, element el
    WHERE el.doc_id = a.id
    and el.elementtype_id in (
                                    4494, --Сумма
                                    4711, -- терминал
                                    5210,-- CardEmbossNum.
                                    5182 -- Идентификатор запроса.
                            )
    AND rownum > 0
    GROUP BY a.id, a.num_doc, status, a.date_doc,   a.PmtRefId
    )
)

, docs AS (
select /* USE_HASH(bri) ordered full(el) parallel(el 4)*/
    distinct
    el.doc_id,
    el.dateel,
    d.status,
    d.num_doc,
    d.date_doc,
    bri.term_id,
    p_common.to_num(bri.summ)*100 as summ,
    regexp_replace(bri.emboss_num, '\*+', '%') as emboss_mask,
    el.value as emboss_num,
    p_common.getdocattr(d.id, 'Идентификатор запроса') as erip_id
from bri, element el, doc d
where el.elementtype_id = 5210 -- CardEmbossNum.
and el.date_doc = bri.date_doc
and el.value = bri.emboss_num
AND d.id = el.doc_id
AND p_common.getdocattr(d.id, 'Сумма') = bri.summ
AND p_common.getdocattr(d.id, 'Идентификатор терминального устройства') = bri.term_id
AND rownum > 0

)

, mpcs AS (
-- BRI + прямые MPCS
SELECT 
    min(time_delta)over(partition by term_id, emboss_number, amount, trunc(tr_date)) as min_time_delta,
    sum(decode(a.status, 'OK', a.summ, 0)/docs_cnt)over(partition by a.term_id, a.emboss_num, trunc(a.date_doc)) as bri_total,
    count(a.mpcs_id)over(partition by a.mpcs_id) as mpcs_cnt, 
    a.*
FROM (
        select /*+ ordered USE_HASH(docs) index(m TRANSACTION_DATE) DRIVING_SITE(m)*/ 
            abs(dateel - tr_date)* 86400 as time_delta,
            count(docs.doc_id)over(partition by docs.doc_id) as docs_cnt,
            docs.*, '>><<', 
            m.id as mpcs_id, m.tr_date, m.amount, emboss_number, ref_nr, appr_code, revers_id, hand_reversals
        from docs
        LEFT JOIN mpcs_slips@bars m
        ON  m.tr_date between  :date_start and :date_end+1
        AND m.term_id = docs.term_id
        and m.amount = docs.summ
        and m.emboss_number like docs.emboss_mask
        and abs(m.tr_date - docs.dateel)*86400 < 120
        and trunc(msg_type/100) != 14
    )a
)

, reversals AS (
select /*+ index(rev MPCS_SLIPS_ID) DRIVING_SITE(rev)*/ 
    mpcs.mpcs_id, 
    rev.id as rev_id,
    rev.ref_nr as rev_ref_nr,
    rev.appr_code as rev_appr_code
from mpcs, mpcs_slips@bars rev
WHERE rev.id = mpcs.revers_id
AND trunc(rev.msg_type/100) = 14

UNION 

select /*+ LEADING(rev) index(rev TRANSACTION_DATE) DRIVING_SITE(rev)*/  
    mpcs.mpcs_id, 
    rev.id as rev_id,
    rev.ref_nr as rev_ref_nr,

    rev.appr_code as rev_appr_code
from  mpcs_slips@bars rev, mpcs
WHERE rev.tr_date >= :date_start 
AND trunc(rev.msg_type/100) = 14
AND mpcs.term_id = rev.term_id
AND mpcs.ref_nr = rev.ref_nr
AND mpcs.appr_code = rev.appr_code
AND mpcs.summ = rev.amount
AND rownum > 0
)

SELECT*
FROM (
SELECT a.*
FROM (
    SELECT 
        sum(decode(r.rev_id, NULL, mpcs.amount, 0)/mpcs.mpcs_cnt)over(partition by mpcs.term_id, mpcs.emboss_number, trunc(tr_date)) as mpcs_total,
        mpcs.*, r.rev_id, r.rev_ref_nr, r.rev_appr_code
    FROM mpcs
    LEFT JOIN reversals r
    ON mpcs.mpcs_id = r.mpcs_id

    )a
WHERE mpcs_total != bri_total
AND time_delta = min_time_delta
)
WHERE CASE
            WHEN status = 'OK' and mpcs_id IS NULL THEN 1
            WHEN status = 'OK' and revers_id IS NOT NULL  THEN 1
            WHEN status != 'OK' and mpcs_id IS NOT NULL AND revers_id IS NULL THEN 1
            ELSE 0
        END = 1
```