
```plsql
DECLARE
    p_date_doc DATE := trunc(sysdate);
    p_next_doc_id NUMBER;
    p_info VARCHAR2(100) := '|IM834853(262477)';
    p_turn_id NUMBER;
    v_error_msg VARCHAR2(4000);
    v_processed_count NUMBER := 0;
BEGIN 
    FOR rec IN (
        SELECT a.*, acc.id as account_id_to, acc.iban as iban_to, acc.currency_id as currency_to,
            p_common.getdocattr(acc.doc_id, 'Идентификатор кошелька') as wallet_id,
            (SELECT MAX(ID) FROM DOC WHERE PARENT_ID = CARD_DEP_FROM AND STATUS = 'OK' AND DOCTYPE_ID = 5409) AS REASON,
            (select substr(max(to_char(datestat, 'yyyymmddhh24miss')||value), 15) from accstatus where account_id = acc.id and elementtype_id = 1) as bank_to
        FROM (
            select cop.parent_id, sum, 
            c.holder,
            deposit as card_dep_from, 
            p_common.getdocattr(dd.id, 'ID Вклада') as deposit_to
            from card_op cop, card c, doc dd  
            where cop.parent_id in (4535164661, 4535176375, 4535188325, 4535193472, 4535194225, 4535198481, 4535204673, 4535207958, 4535210321, 4535212952, 4535215052, 4535216716, 4535218478)
            and c.mscardid = cop.card
            and dd.parent_id = c.deposit
            AND dd.doctype_id = 5409 
            and dd.status = 'OK'
            ) a, account acc
        WHERE acc.doc_id = deposit_to 
        AND acc.acc_type_id = 2
        -- Блокировка строк счета на время транзакции для целостности
        FOR UPDATE OF acc.id 
    ) 
    LOOP
        BEGIN
            -- 1. Основной документ
            INSERT INTO doc 
            VALUES(rec.parent_id, 1728, NULL, p_date_doc, 'OK', '1', NULL, 1211);
            
            -- 2. Элементы документа
            INSERT INTO element VALUES(element_id.nextval, 6087, rec.parent_id, rec.bank_to, sysdate, NULL, 1211, NULL, '1', p_date_doc);
            INSERT INTO element VALUES(element_id.nextval, 6088, rec.parent_id, rec.deposit_to, sysdate, NULL, 1211, NULL, '1', p_date_doc);
            INSERT INTO element VALUES(element_id.nextval, 10007, rec.parent_id, REC.REASON, sysdate, NULL, 1211, NULL, '1', p_date_doc);
            INSERT INTO element VALUES(element_id.nextval, 6096, rec.parent_id, 'OK', sysdate, NULL, 1211, NULL, '1', p_date_doc);
            INSERT INTO element VALUES(element_id.nextval, 6085, rec.parent_id, rec.sum, sysdate, NULL, 1211, NULL, '1', p_date_doc);
            INSERT INTO element VALUES(element_id.nextval, 6086, rec.parent_id, '75', sysdate, NULL, 1211, NULL, '1', p_date_doc);
            
            -- 3. (WIRE)
            INSERT INTO WIRE
            VALUES (wire_id.nextval, rec.parent_id, 'BY18BLBB38020000000000000052', rec.iban_to, rec.currency_to, p_date_doc, NULL, rec.deposit_to, rec.sum, 1211, rec.bank_to, NULL, rec.bank_to, '2', p_date_doc, '75', p_info, NULL, rec.account_id_to );

            -- 4. Обработка оборотов (ACCTURN) с защитой от дубликатов
            BEGIN
                select max(id) into p_turn_id from accturn 
                where account_id = rec.account_id_to and date_turn = p_date_doc;


                IF p_turn_id IS NULL THEN 
                    select ACCTURN_ID.NEXTVAL INTO p_turn_id FROM dual;
                    INSERT INTO accturn 
                    VALUES (p_turn_id, rec.account_id_to, p_date_doc, 0, 0, rec.sum, 0, 0, 0);
                ELSE
                    update accturn set kredit = kredit + rec.sum 
                    WHERE id = p_turn_id;
                END IF;
            EXCEPTION
                WHEN DUP_VAL_ON_INDEX THEN
                    -- Если вдруг вставка не прошла из-за уникальности (гонка данных), пробуем обновить
                    update accturn set kredit = kredit + rec.sum 
                    WHERE account_id = rec.account_id_to AND date_turn = p_date_doc;
            END;
        
            -- 5. Логика кошелька
            IF NVL(rec.wallet_id, ' ') != ' ' THEN
            
                select DOC_ID.NEXTVAL into p_next_doc_id FROM dual;
                
                INSERT INTO element VALUES(element_id.nextval, 6617, rec.parent_id, to_char(p_next_doc_id), sysdate, NULL, 1211, NULL, '1', p_date_doc);
            
                INSERT INTO doc VALUES (p_next_doc_id, 1730, NULL, p_date_doc, 'OK', '1', NULL, 1211);
                INSERT INTO element VALUES(element_id.nextval, 6102, p_next_doc_id, '739', sysdate, NULL, 1211, NULL, '1', p_date_doc);
                INSERT INTO element VALUES(element_id.nextval, 6103, p_next_doc_id, rec.deposit_to, sysdate, NULL, 1211, NULL, '1', p_date_doc);                 
                INSERT INTO element VALUES(element_id.nextval, 17404, p_next_doc_id, rec.holder, sysdate, NULL, 1211, NULL, '1', p_date_doc);
                INSERT INTO element VALUES(element_id.nextval, 6757, p_next_doc_id, rec.parent_id, sysdate, NULL, 1211, NULL, '1', p_date_doc);
                INSERT INTO element VALUES(element_id.nextval, 6101, p_next_doc_id, rec.sum, sysdate, NULL, 1211, NULL, '1', p_date_doc);
                INSERT INTO element VALUES(element_id.nextval, 6105, p_next_doc_id, '76', sysdate, NULL, 1211, NULL, '1', p_date_doc);       
                
                INSERT INTO WIRE
                    VALUES (wire_id.nextval, p_next_doc_id, rec.iban_to, 'BY81BLBB31190000000000091025', rec.currency_to, p_date_doc, rec.deposit_to, NULL,  rec.sum, 1211, '739',  rec.bank_to, NULL, '2', p_date_doc, '76', p_info,  rec.account_id_to, NULL);


                IF p_turn_id IS NOT NULL THEN
                    update accturn set debet = debet + rec.sum 
                    WHERE id = p_turn_id;
                END IF;    
            END IF;    
            
            v_processed_count := v_processed_count + 1;

        EXCEPTION
            WHEN OTHERS THEN

                v_error_msg := 'Error on parent_id: ' || rec.parent_id || '. Msg: ' || SQLERRM;
                DBMS_OUTPUT.PUT_LINE(v_error_msg);
                RAISE; -- Прерываем весь скрипт, чтобы сработал внешний ROLLBACK
        END;
    END LOOP;
    
    -- Фиксация изменений только если цикл прошел без ошибок
   -- COMMIT;
    DBMS_OUTPUT.PUT_LINE('Success. Processed: ' || v_processed_count);

EXCEPTION
    WHEN OTHERS THEN
        -- Откат всех изменений в случае любой ошибки
        ROLLBACK;
        v_error_msg := 'Script failed. ' || SQLERRM;
        DBMS_OUTPUT.PUT_LINE(v_error_msg);
        RAISE; -- Пробрасываем ошибку дальше, чтобы вызывающая система знала о провале
END;
```