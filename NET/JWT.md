JWT — это **"цифровой паспорт"**, который одна система (например, сервер аутентификации) выдает пользователю. Пользователь затем может предъявлять этот "паспорт" другим системам (например, защищенным API), чтобы подтвердить свою личность и права доступа.

### НАЗНАЧЕНИЕ
JWT в основном используется для двух целей:

1. **Аутентификация и авторизация:** Это самый распространенный сценарий.
    
    - **Как это работает:** Когда пользователь входит в систему, используя свои учетные данные (логин и пароль), сервер проверяет их и, в случае успеха, генерирует JWT и отправляет его пользователю.
        
    - **Где используется:** Этот токен сохраняется на стороне клиента (например, в `localStorage` или `cookie`). При каждом последующем запросе к защищенным ресурсам, клиент отправляет этот JWT в заголовке `Authorization` (обычно как `Bearer` токен).
        
    - **Для чего:** Сервер, получая токен, проверяет его подпись. Если подпись верна, сервер доверяет информации внутри токена и предоставляет доступ к запрошенному ресурсу, избавляя от необходимости каждый раз проверять логин и пароль по базе данных.
        
2. **Безопасный обмен информацией:** JWT можно использовать для безопасной передачи информации между различными сервисами. Поскольку токен подписан, получатель может быть уверен, что данные не были изменены в пути.

### Структура и кодирование JWT 

JWT состоит из трех частей, разделенных точками (`.`):
В сборе это выглядит так: `xxxxx.yyyyy.zzzzz`

1. **Заголовок (Header)** Это JSON-объект, который обычно состоит из двух полей:
	- `alg`: алгоритм, используемый для создания подписи (например, `HS256` или `RS256`).
    - `typ`: тип токена, всегда `JWT`.
	```json
	    {
	  "alg": "HS256",
	  "typ": "JWT"
	}
	```
	Этот JSON кодируется в строку **Base64Url**.
	
2. **Полезная нагрузка (Payload)**
    Это JSON-объект, содержащий **утверждения (claims)** — информацию о пользователе и дополнительные данные. Существует три типа утверждений:
	- **Зарегистрированные (Registered claims):** Стандартные поля, такие как `iss` (издатель токена), `exp` (время истечения срока действия), `sub` (тема, ID пользователя), `aud`.
	- **Публичные (Public claims):** Поля, которые определяются теми, кто использует JWT. Чтобы избежать совпадений, их следует регистрировать.
	- **Приватные (Private claims):** Нестандартные поля, созданные для обмена информацией между сторонами.
		```json
		{
		  "sub": "1234567890",
		  "name": "John Doe",
		  "admin": true,
		  "iat": 1516239022
		}
		```
	Эта часть также кодируется в **Base64Url**.

	**Важно:** Информация в заголовке и полезной нагрузке **не шифруется**, а только кодируется. Это значит, что любой может её прочитать. Поэтому **никогда не храните в JWT конфиденциальные данные**, такие как пароли.
	
1. **Подпись (Signature)**

Это самая важная часть для обеспечения безопасности. Подпись создается путем объединения закодированных заголовка и полезной нагрузки, секретного ключа (хранится только на сервере) и применения указанного в заголовке алгоритма (`alg`).
Процесс создания подписи (для HS256):
```
HMACSHA256( 
	base64UrlEncode(header) + "." + base64UrlEncode(payload), 
	your-256-bit-secret 
)
```
Кодируется защищенным шифрованием, алгоритм которого указан в разделе `header`
### ### Проверка подлинности

Когда клиент отправляет токен на сервер, сервер выполняет следующие шаги:
1. **Разделение токена:** Сервер разделяет токен на три части: заголовок, полезную нагрузку и подпись.
2. **Восстановление подписи:** Используя тот же секретный ключ и алгоритм хеширования, сервер заново вычисляет подпись на основе полученных заголовка и полезной нагрузки.
3. **Сравнение:** Сервер сравнивает вновь вычисленную подпись с подписью, пришедшей в токене от клиента.
    - Если подписи совпадают, это означает, что данные **не были изменены** после выдачи токена.
    - Если подписи не совпадают, сервер отклоняет токен, так как это указывает на попытку подмены.
        

Поскольку у злоумышленника нет **секретного ключа**, он не может правильно сгенерировать новую подпись, даже если изменит данные в полезной нагрузке. Таким образом, любое изменение данных сделает токен недействительным.


### JWT И БЕЗОПАСТНОСТЬ
- **Гарантия целостности:** Сервер может быть уверен, что информация _внутри_ токена (например, ID пользователя, его права) не была изменена после его выпуска. Это обеспечивается **цифровой подписью**. Если злоумышленник изменит полезную нагрузку (Payload), подпись станет недействительной, и сервер отвергнет такой токен. 

- JWT не защищает от последствий _кражи_ токена. Он защищает от _подделки_ токена

- **Предотвращение перехвата:** Основная защита строится вокруг того, чтобы токен в принципе было невозможно перехватить.

- Токены всегда должны передаваться только по зашифрованному каналу **HTTPS (TLS)** HTTPS шифрует весь трафик между клиентом и сервером, делая перехват токена практически невозможным.

- Каждый JWT должен иметь короткий срок жизни, установленный в поле `exp` (expiration). Обычно это от 5 до 15 минут.

- Использование Refresh-токенов. Для решения проблемы короткого срока жизни используется пара токенов:
	- **Access Token:** Короткоживущий (5-15 минут), используется для доступа к ресурсам. Его кража не так страшна.
    - **Refresh Token:** Долгоживущий (дни, недели). Он хранится в более безопасном месте и используется только для одной цели — получения нового `Access Token`, когда старый истек.
    
- Безопасное хранение на клиенте.  Хранить токен следует в `cookie` с флагом **`HttpOnly`**. Такой cookie не доступен для чтения через JavaScript, что значительно снижает риск его кражи через XSS.


### Список ресурсов для работы с JWT 

- **[jwt.io](https://jwt.io/)** — главный ресурс. Здесь можно декодировать, проверять и создавать JWT. Также содержит список библиотек для всех популярных языков программирования.
    
- **[RFC 7519](https://tools.ietf.org/html/rfc7519)** — официальная спецификация стандарта JWT.
    
- **Библиотеки для разных языков (некоторые из популярных):**
    - **Node.js:** `jsonwebtoken`, `node-jose`
    - **Python:** `PyJWT`
    - **Java:** `java-jwt` (от Auth0), `jjwt`
    - **C# / .NET:** `System.IdentityModel.Tokens.Jwt`
    - **Go:** `jwt-go`
    - **PHP:** `firebase/php-jwt`
- **[Auth0](https://auth0.com/docs/jwt)** — компания Auth0 предоставляет отличную документацию и статьи по использованию JWT.