**Балансировка нагрузки** (Load Balancing) — это метод распределения входящего сетевого трафика и запросов пользователей равномерно по пулу ресурсов (обычно это группа серверов, называемая **фермой** или **пулом серверов**), поддерживающих приложение или сервис.

Этот процесс управляется специальным устройством или программным обеспечением, называемым **балансировщиком нагрузки** (Load Balancer), который выступает в качестве посредника между клиентами и серверами.

## Для Чего Применяется Балансировка Нагрузки?

Балансировка нагрузки — критически важный элемент архитектуры высоконагруженных сервисов, который решает несколько ключевых задач:

- **Оптимизация Использования Ресурсов (Производительность):** Равномерное распределение нагрузки гарантирует, что ни один отдельный сервер не будет перегружен, что помогает минимизировать время отклика и максимально увеличить пропускную способность системы в целом.
    
- **Высокая Доступность и Отказоустойчивость (Availability and Fault Tolerance):** Балансировщик нагрузки постоянно отслеживает **работоспособность** (Health Checks) серверов. В случае выхода из строя или обнаружения проблемы на одном из серверов, он автоматически перестает направлять туда трафик, перенаправляя его на остальные работоспособные узлы. Это обеспечивает непрерывность работы сервиса.
    
- **Масштабируемость (Scalability):** Позволяет легко добавлять или удалять серверы из пула (горизонтальное масштабирование) в зависимости от текущего спроса без остановки работы сервиса.

## Основные Понятия, которыми Аппелирует Балансировка Нагрузки

При обсуждении балансировки нагрузки часто используются следующие термины:

| **Понятие**                                            | **Определение**                                                                                                                                                                                           |
| ------------------------------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Балансировщик Нагрузки (Load Balancer)**             | Аппаратное устройство или программное обеспечение, которое принимает входящий трафик и распределяет его между бэкенд-серверами согласно выбранному алгоритму.                                             |
| **Ферма/Пул Серверов (Server Farm/Pool)**              | Группа идентичных серверов, выполняющих одну и ту же задачу, между которыми распределяется нагрузка.                                                                                                      |
| **Проверка Работоспособности (Health Check)**          | Механизм, используемый балансировщиком нагрузки для периодической проверки доступности и готовности каждого сервера в пуле обрабатывать запросы.                                                          |
| **Сессия (Session)**                                   | Последовательность сетевых взаимодействий между клиентом и сервером.                                                                                                                                      |
| **Устойчивость Сессии (Session Persistence/Affinity)** | Обеспечение того, чтобы запросы от одного и того же клиента всегда направлялись на один и тот же сервер. Это необходимо для приложений, которые хранят состояние сессии локально на сервере.              |
| **Уровни Балансировки**                                | **L4 (Транспортный уровень):** Маршрутизация на основе IP-адресов и портов (TCP/UDP). **L7 (Прикладной уровень):** Маршрутизация на основе содержимого запроса (например, заголовков HTTP, URL, cookies). |

## Алгоритмы Балансировки Нагрузки

Алгоритмы определяют логику, по которой балансировщик нагрузки выбирает сервер для обработки очередного запроса. Они делятся на **статические** и **динамические**.

### 1. Статические Алгоритмы (Static)

Эти алгоритмы распределяют трафик без учета текущего состояния нагрузки на серверах.
#### **Round Robin (Циклический/Карусельный):** 
Распределяет запросы последовательно по списку серверов. Сервер 1, Сервер 2, Сервер 3, Сервер 1, Сервер 2...

#### **Weighted Round Robin (Взвешенный Циклический):**
Позволяет администратору присвоить каждому серверу **вес** (Weight) в зависимости от его производительности. Серверы с большим весом получают больше запросов.

#### **IP Hash (Хэширование IP-адреса):** 
Использует IP-адрес клиента (или комбинацию IP и порта) для вычисления хэш-значения, которое определяет, на какой сервер будет направлен запрос. Обеспечивает **устойчивость сессии**.
    


#### **Random** (также известный как **случайный выбор**) 
Это простейший статический алгоритм балансировки, который направляет входящие запросы на один из доступных серверов в пуле, выбирая его **случайным образом**.
- **Принцип работы:** При поступлении запроса балансировщик использует генератор случайных чисел для выбора целевого сервера.
    
- **Применение:** Эффективен, когда все серверы имеют **одинаковую** производительность и находятся в здоровом состоянии. В долгосрочной перспективе, при большом объеме трафика, случайность, как правило, приводит к довольно равномерному распределению.
    
- **Преимущества:**
	    - **Простота и скорость:** Очень низкие вычислительные затраты на балансировщике.
	    - **Равномерность:** Со временем обеспечивает хорошее распределение нагрузки.
        
- **Недостатки:**
	    - **Кратковременная неравномерность:** На коротких интервалах или при небольшом общем объеме трафика может возникнуть ситуация, когда один сервер получит непропорционально больше запросов, чем другие.


#### Алгоритм **Consistent Hashing (Последовательное Хэширование)**
**Consistent Hashing** — это продвинутый алгоритм, который решает ключевую проблему традиционного хэширования по модулю ($h(key) \pmod N$), где $N$ — количество серверов. При добавлении или удалении сервера в традиционной схеме почти все отображения ключей на серверы меняются, что вызывает массовое перемещение данных или переподключение сессий.
- **Принцип работы:**
    1. **Хэш-кольцо:** Алгоритм отображает **как серверы (узлы), так и ключи (запросы/данные)** на общее виртуальное пространство, часто представляемое как кольцо (Хэш-кольцо).
    2. **Назначение:** Запрос (или ключ данных) направляется на ближайший сервер, расположенный **по часовой стрелке** от его собственной позиции на кольце.
    3. **Виртуальные узлы (V-Nodes):** Для улучшения равномерности распределения каждый физический сервер часто представляется на кольце **множеством виртуальных узлов**.        
- **Применение:** Критически важен для распределенных систем и кэшей (например, Memcached, Redis, CDN), где необходимо **минимизировать перемещение данных** при масштабировании.
    
- **Преимущества:**
    - **Минимальное перераспределение:** При добавлении или удалении одного сервера только ключи, которые были назначены ему, и ключи, которые теперь попадают в его зону влияния, будут переназначены (это **$1/N$** от общего числа, где $N$ — число серверов), а не все ключи.
    - **Высокая устойчивость сессии:** Гарантирует, что конкретный ключ (например, ID пользователя, IP-адрес) почти всегда будет направлен на один и тот же сервер, что важно для кэширования и сохранения состояния.


### 2. Динамические Алгоритмы (Dynamic) - Load-based
Эти алгоритмы учитывают текущую нагрузку, производительность или состояние серверов при принятии решения.

#### **Least Connection (Наименьшее Количество Соединений):**
Направляет новый запрос на сервер с **наименьшим количеством активных соединений** в данный момент. Это один из самых эффективных алгоритмов для большинства сценариев.

#### **Weighted Least Connection (Взвешенное Наименьшее Количество Соединений):** 
Аналогичен предыдущему, но учитывает присвоенный серверу вес. Запрос направляется на сервер с наименьшим соотношением (Активные Соединения) / (Вес Сервера).
#### **Least Response Time (Наименьшее Время Отклика):**
Направляет трафик на сервер с наименьшим средним временем ответа (или наименьшим количеством активных соединений и наименьшим временем ответа).

#### Resource-based:
**Использование ресурсов (CPU, память, I/O).** Запрос идет на сервер, где меньше всего загружен процессор или есть больше свободной памяти.