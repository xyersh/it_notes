


**Bulkhead** —Ä–∞–∑–¥–µ–ª—è–µ—Ç —Ä–µ—Å—É—Ä—Å—ã (–ø–æ—Ç–æ–∫–∏, —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è, –ø–∞–º—è—Ç—å, goroutines –∏ —Ç.–¥.) –º–µ–∂–¥—É **—Ä–∞–∑–Ω—ã–º–∏ —á–∞—Å—Ç—è–º–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–ª–∏ —Ä–∞–∑–Ω—ã–º–∏ –≤–Ω–µ—à–Ω–∏–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏**, —á—Ç–æ–±—ã:

- –ü—Ä–æ–±–ª–µ–º—ã —Å –æ–¥–Ω–∏–º —Å–µ—Ä–≤–∏—Å–æ–º **–Ω–µ –∏—Å—á–µ—Ä–ø—ã–≤–∞–ª–∏ –æ–±—â–∏–µ —Ä–µ—Å—É—Ä—Å—ã**
- –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã –ø—Ä–æ–¥–æ–ª–∂–∞–ª–∏ —Ä–∞–±–æ—Ç–∞—Ç—å **–¥–∞–∂–µ –ø—Ä–∏ —á–∞—Å—Ç–∏—á–Ω–æ–º —Å–±–æ–µ**
–í —Ü–µ–ª–æ–º, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Bulkhead –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∏–∑–æ–ª—è—Ü–∏—é —Ä–µ—Å—É—Ä—Å–æ–≤ –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏/–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏, –ê –¢–ê–ö–ñ–ï, –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—é —Å–±–æ–µ–≤, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–∞—Å—Ç–∏—á–Ω–æ–π —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

## –ú–æ—Ç–∏–≤–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Bulkhead
Bulkhead —É–º–µ—Å—Ç–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —Å–ª—É—á–∞—è—Ö:
- **–ö–∞—Å–∫–∞–¥–Ω—ã–π —Å–±–æ–π** - –ï—Å–ª–∏ `Service A` –∑–∞–≤–∏—Å–∞–µ—Ç, –æ–Ω –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å–µ –≥–æ—Ä—É—Ç–∏–Ω—ã ‚Äî —Ç–æ–ª—å–∫–æ –≤—ã–¥–µ–ª–µ–Ω–Ω—É—é –µ–º—É ¬´–ø–µ—Ä–µ–±–æ—Ä–∫—É¬ª
- **–ò—Å—á–µ—Ä–ø–∞–Ω–∏–µ –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π** - –í—ã–∑–æ–≤—ã –∫ –º–µ–¥–ª–µ–Ω–Ω–æ–º—É API –Ω–µ –∑–∞–π–º—É—Ç –≤—Å–µ —Å–ª–æ—Ç—ã –≤ –æ–±—â–µ–º HTTP-–∫–ª–∏–µ–Ω—Ç–µ
- **–ù–µ—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞** - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–ø–ª–∞—Ç–µ–∂–∏) –∑–∞—â–∏—â–µ–Ω—ã –æ—Ç –≤–ª–∏—è–Ω–∏—è –º–µ–Ω–µ–µ –≤–∞–∂–Ω—ã—Ö (–æ—Ç–ø—Ä–∞–≤–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏)



## –ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
–î–æ–ø—É—Å—Ç–∏–º, –∏–º–µ–µ—Ç—Å—è –¥–≤–∞ –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–∞: **–ø–ª–∞—Ç—ë–∂–Ω—ã–π** –∏ **emailer**. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ, —á—Ç–æ–±—ã –ø—Ä–æ–±–ª–µ–º—ã —Å emailer‚Äô–æ–º –Ω–µ –º–µ—à–∞–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–µ–π.

```go
package main

import (
    "context"
    "fmt"
    "sync"
    "time"
)

// –°–æ–∑–¥–∞—ë–º "–ø–µ—Ä–µ–±–æ—Ä–∫—É" ‚Äî –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –ø—É–ª –≥–æ—Ä—É—Ç–∏–Ω
type Bulkhead struct {
    sem chan struct{}
}

func NewBulkhead(concurrency int) *Bulkhead {
    return &Bulkhead{sem: make(chan struct{}, concurrency)}
}

func (b *Bulkhead) Do(ctx context.Context, fn func()) error {
    select {
    case b.sem <- struct{}{}: // –∑–∞–Ω—è—Ç—å —Å–ª–æ—Ç
        defer func() { <-b.sem }() // –æ—Å–≤–æ–±–æ–¥–∏—Ç—å
        fn()
        return nil
    case <-ctx.Done():
        return ctx.Err()
    }
}

// –ò–º–∏—Ç–∞—Ü–∏—è –≤—ã–∑–æ–≤–∞ —Å–µ—Ä–≤–∏—Å–∞
func callPaymentService(id int) {
    fmt.Printf("üí≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞ %d...\n", id)
    time.Sleep(100 * time.Millisecond)
}

func callEmailService(id int) {
    fmt.Printf("üìß –û—Ç–ø—Ä–∞–≤–∫–∞ email %d...\n", id)
    time.Sleep(2 * time.Second) // –∏–º–∏—Ç–∞—Ü–∏—è –º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
}

func main() {
    ctx := context.Background()

    // –†–∞–∑–Ω—ã–µ –ø–µ—Ä–µ–±–æ—Ä–∫–∏
    paymentBH := NewBulkhead(2) // –º–∞–∫—Å–∏–º—É–º 2 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–∞
    emailBH := NewBulkhead(1)   // –º–∞–∫—Å–∏–º—É–º 1 email –∑–∞ —Ä–∞–∑

    var wg sync.WaitGroup

    // –ó–∞–ø—É—Å–∫–∞–µ–º –º–Ω–æ–≥–æ –∑–∞–¥–∞—á
    for i := 1; i <= 5; i++ {
        wg.Add(2)

        // –ü–ª–∞—Ç–µ–∂–∏
        go func(i int) {
            defer wg.Done()
            _ = paymentBH.Do(ctx, func() { callPaymentService(i) })
        }(i)

        // Email'—ã
        go func(i int) {
            defer wg.Done()
            _ = emailBH.Do(ctx, func() { callEmailService(i) })
        }(i)
    }

    wg.Wait()
    fmt.Println("–í—Å–µ –∑–∞–¥–∞—á–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã")
}
```