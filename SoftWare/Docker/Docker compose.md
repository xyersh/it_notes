
docker-compose.yaml



### Команды Docker Compose

#### Запуск и остановка
- `docker-compose up` - Запускает контейнеры, определенные в файле `docker-compose.yml`. Принимает следующие флаги:
		- `-d`, `--detach` - Запускает контейнеры в фоновом режиме
		- `--build` -  Пересобирает образы перед запуском
		- `--force-recreate` - Принудительно создает новые контейнеры, даже если их конфигурация не изменилась
		- `--scale [CONTAINER]=[NUM_OF_REPLICKS]`

- `docker-compose restart` - Перезапускает контейнеры.
- `docker-compose start` - Запускает остановленные контейнеры.
- `docker-compose stop`- остановить (не удаляя) весь стек контейнеров, описанных в compose-файле
- `docker-compose down`- остановить и уничтожить весь стек контейнеров, описанных в compose-файле
	- `--rmi all` - Удаляет все образы, используемые в проекте
	- `-v`  -  (volumes): Удаляет именованные тома.

#### Управление состоянием 
- `docker-compose ps` - Показывает статус контейнеров.
- - `docker-compose logs` - просмотр стека логов для всех приложений указанных в **docker-compose.yaml**
	- `-f` (follow)- Показывает логи в реальном времени.
	- `--tail [number]`- Показывает только последние `[number]` строк логов.
- `docker-compose top`: Отображает запущенные процессы внутри контейнеров.
- `docker-compose exec`: Выполняет команду внутри запущенного контейнера.
	- `-T` (no-tty): Отключает псевдо-терминал.
	- `-d` (detached): Запускает команду в фоновом режиме.
	- `[service_name] [command]`: Выполняет указанную команду в указанном сервисе.
- `docker-compose run`: Запускает одноразовую команду в новом контейнере, созданном из сервиса. Отличается от `exec` тем, что создает новый контейнер.
	- `--rm`: Удаляет контейнер после завершения команды.
	- `[service_name] [command]`: Запускает команду в новом контейнере.

#### Сборка и обслуживание
- `docker-compose build`: Собирает образы для сервисов, которые используют `build`.
    - `--no-cache`: Не использует кэш при сборке образа.
- `docker-compose pull`: Загружает образы сервисов из реестра.
- `docker-compose config`: Валидирует и выводит итоговую конфигурацию. Помогает найти синтаксические ошибки в файле `docker-compose.yml`.
    - `-q` (quiet): Не выводит результат, только статус выхода.


### docker-compose.yml - разбор

```yml
version: '3.8'

services:
  web:
    build: .
    ports:
      - "3000:3000"
    volumes:
      - .:/usr/src/app
    depends_on:
      - db
    networks:
      - app-net

  db:
    image: postgres:13
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=mydatabase
    volumes:
      - db_data:/var/lib/postgresql/data
    networks:
      - app-net

networks:
  app-net:
    driver: bridge

volumes:
  db_data:
```

**`version`**: Обязательный первый ключ. Он определяет версию синтаксиса файла Compose. Рекомендуется использовать **версию 3.8** или выше, так как она поддерживает множество полезных функций, таких как именованные тома и сети, а также позволяет работать с Docker Swarm.

**`services`**: Самый важный раздел. Здесь вы определяете **сервисы** — контейнеры, из которых состоит ваше приложение. Каждый сервис:
- имеет уникальное имя (например, `web`, `db`, `redis`).
- может быть настроен с помощью различных параметров.

**`networks`**: Этот раздел используется для определения **пользовательских сетей**. Docker Compose автоматически создает сеть по умолчанию, но иногда вам нужно больше контроля, например, для разделения сервисов или подключения к существующим сетям.

**`volumes`**: Здесь вы определяете **именованные тома**, которые позволяют сохранять данные даже после удаления контейнеров. Это критически важно для баз данных и других сервисов, которым нужно хранить состояние.

#### Ключевые параметры внутри `services`
- `image` или `build`
	- **`image`**: Указывает на готовый образ Docker, который будет использоваться для создания контейнера. Это самый простой способ, если у вас уже есть образ на Docker Hub или в другом реестре.
     _Пример_: `image: "nginx:latest"`
        
	- **`build`**: Указывает путь к директории, где находится **`Dockerfile`**. Docker Compose будет использовать этот `Dockerfile` для сборки образа перед запуском контейнера.
     _Пример_: `build: .` (собирает образ из текущей директории).

- **`ports`**: Пробрасывает порты с хоста на контейнер. `ports` является массивом значений.
	- _Формат_: `"хост:контейнер"`.
	- _Пример_: `ports: - "8080:80"` (перенаправляет запросы с порта 8080 на вашем компьютере на порт 80 в контейнере).
	
- **`volumes`**: Монтирует тома или директории. Это позволяет сохранять данные или синхронизировать код между хостом и контейнером. Является массивом занчений.
	- **Монтирование директории**: `volumes: - "./app:/usr/src/app"` (монтирует локальную папку `app` в `/usr/src/app` внутри контейнера).
	- **Именованный том**: `volumes: - db_data:/var/lib/mysql` (использует именованный том `db_data`, который должен быть определен в разделе `volumes`).
	
- **`environment`**: Устанавливает **переменные окружения** внутри контейнера. Это часто используется для передачи учетных данных, настроек базы данных или ключей API.  Является массивом значений.
	```yml
	environment:
		- POSTGRES_USER=myuser
		- POSTGRES_PASSWORD=mypassword
	```

- **`depends_on`**: Определяет зависимости между сервисами. Docker Compose запустит сервисы в правильном порядке. Является массивом знначений.

- **`networks`**: Подключает сервис к одной или нескольким пользовательским сетям. Является массивом значений.
	_Пример_: `networks: - myapp-network` (подключает сервис к сети `myapp-network`, определенной в основном разделе `networks`).


#### Ключевые параметры внутри `volumes`

- `driver`: Этот параметр позволяет указать **драйвер тома**. Docker по умолчанию использует драйвер `local`, который создает тома в локальной файловой системе хоста. Однако можно использовать сторонние драйверы, например, для работы с удалённым хранилищем или облачными сервисами (AWS S3, Google Cloud Storage и т.д.).
    
- `driver_opts`: С помощью этого ключа можно передать **опции драйверу**. Эти опции зависят от выбранного драйвера и могут использоваться для настройки специфических параметров, таких как путь монтирования, тип файловой системы, или учетные данные для удаленного хранилища.
```yml
version: '3.8'

services:
  db:
    image: postgres:13
    volumes:
      - my_data:/var/lib/postgresql/data

volumes:
  my_data:
    driver: local
    driver_opts:
      type: nfs
      o: addr=10.10.0.200,nolock,soft,rw
      device: ":/srv/nfs/volumes/my_data"
```


#### Ключевые параметры внутри `volumes`

- `driver`: Этот параметр указывает **тип сетевого драйвера**. Самые распространённые драйверы:
    - `bridge`: Создаёт изолированную сеть между контейнерами на одном хосте. Это драйвер по умолчанию.
    - `overlay`: Используется для создания сетей, охватывающих несколько хостов. Это необходимо для работы в кластере Docker Swarm.
    - `host`: Контейнер использует сетевой стек хоста.
        
- `driver_opts`: Позволяет передать **опции драйверу** для дополнительной настройки. Например, можно задать подсеть (subnet), шлюз (gateway) или другие сетевые параметры.
    
- `ipam`: (IP Address Management) Этот параметр позволяет **настроить управление IP-адресами**. Вы можете вручную задать подсеть и шлюз для своей сети, что полезно для более сложной инфраструктуры.

```yml
version: '3.8'

services:
  web:
    image: nginx
    networks:
      - frontend

  api:
    image: my-api
    networks:
      - backend

networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge
    ipam:
      config:
        - subnet: "172.20.0.0/16"
          gateway: "172.20.0.1"
```