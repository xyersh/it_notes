
Инструмент использующийся для управлением блокировок строк на изменение.
Применяется в конструкции **SELECT**
Блокировка строк происходит на время исполнения запроса **SELECT** с  **FOR UPDATE**
Базовый синтаксис:
```sql
SELECT*
FROM table_name
WHERE ...
FOR UPDATE
```

## FOR UPDATE не применим если:
присутствует некая неопределенность, какие строки требуют блокировки
Такое возможно, если в запросе есть:
- **Агрегатные функции и группировка:** 
```sql
SELECT SUM(salary) FROM employees FOR UPDATE
```
- **Операции над множествами (Set Operators):** `UNION`, `UNION ALL`, `INTERSECT`, `MINUS`
- **Ключевое слово `DISTINCT`:**
- **Скалярные подзапросы в списке:**
	```sql
	`SELECT (SELECT name FROM dual) as val --скалярный подзапрос 
	FROM t FOR UPDATE`
	```
- **Псевдостолбцы `LEVEL`, `ROWNUM` (в некоторых контекстах):**
  Часто запрещено в иерархических запросах (`CONNECT BY`).
- **Только для чтения (Read Only):**
	- Если представление (VIEW) создано с опцией `READ ONLY`.
	- Если таблица внешняя (External Table).
- **Выборка из `SAMPLE`:**
```sql
SELECT * FROM t SAMPLE (10) FOR UPDATE
``` 


## Правила использования FOR UPDATE

#### 1. Указывать таблицу (`OF`)
Если используется `JOIN` нескольких таблиц, лучше указать, строки какой именно таблицы вы хотите заблокировать. Это снижает риск блокировок и делает намерения явными.
Если блокируем меньше таблиц, вероятность того, что два процесса заблокируют ресурсы в разном порядке и встанут в тупик, снижается.
Указывать нужно именно столбец, но блокируется вся строка таблицы, которой принадлежит этот столбец.
```sql
-- Блокируем строки только в таблице accounts, а не в joined таблицах
SELECT a.id, b.name
FROM accounts a
JOIN clients b ON a.client_id = b.id
FOR UPDATE OF a.id; 
```
В данном примере блокируется только таблица accounts. Это позволит другим пользователям работать со справочником клиентов, пока мы обрабатываем счета.

#### 2. Использовать `NOWAIT` или `WAIT`
По умолчанию, если строка уже заблокирована другой сессией, ваш запрос "зависнет" и будет ждать вечно (пока та сессия не сделает коммит). В скриптах это опасно.
- `NOWAIT`: Если строка занята, сразу выдать ошибку `ORA-00054`.
- `WAIT n`: Ждать блокировку не более `n` секунд.
- `SKIP LOCKED`: (Очень полезно для очередей) Пропустить заблокированные строки и взять следующие свободные.
```sql
SELECT * FROM accturn 
WHERE account_id = 123 
FOR UPDATE NOWAIT; 
```

#### 3. Держать транзакцию короткой
Не стоит делать `SELECT ... FOR UPDATE`, а потом запускать долгие вычисления в PL/SQL или ждать ввода пользователя. Строки будут заблокированы для всех остальных.
```sql
-- ПЛОХО
SELECT ... FOR UPDATE; -- Заблокировал
DBMS_LOCK.SLEEP(100);  -- Жду 100 секунд (все остальные ждут!)
COMMIT;

-- ХОРОШО
SELECT ... FOR UPDATE;
-- Сразу UPDATE/INSERT
COMMIT;
```



