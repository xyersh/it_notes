
### Команда `ANALYZE`

Это основной и наиболее часто используемый способ обновления статистики.

|Команда|Описание|
|---|---|
|**`ANALYZE;`**|Обновляет статистику **для всей базы данных**. Это может занять много времени на больших базах.|
|**`ANALYZE ИМЯ_ТАБЛИЦЫ;`**|Обновляет статистику **только для указанной таблицы**. Рекомендуется для точечного обновления.|
|**`ANALYZE ИМЯ_ТАБЛИЦЫ (ИМЯ_СТОЛБЦА);`**|Обновляет статистику **только для конкретного столбца** указанной таблицы.|


#### Принцип работы:
- `ANALYZE` **сканирует таблицу** (или её часть, используя выборку) и **собирает статистику** о распределении данных, количестве уникальных значений (`n_distinct`), доле `NULL` (`null_frac`), наиболее частых значениях и гистограммах.
- Собранная информация записывается в системный каталог **`pg_statistic`** (который доступен пользователям через представление **`pg_stats`**).
- Команда **не выполняет очистку** (vacuum) "мёртвых" строк (dead tuples).


### Команда `VACUUM ANALYZE`

Это комбинированная команда, которая выполняет два действия.

| Команда                           | Описание                                                                                                      |
| --------------------------------- | ------------------------------------------------------------------------------------------------------------- |
| **`VACUUM ANALYZE ИМЯ_ТАБЛИЦЫ;`** | Сначала выполняет **очистку** (удаляет "мёртвые" строки, освобождая место), а затем **обновляет статистику**. |

#### Принцип работы:
- **Очистка (VACUUM)**: Удаляет версии строк, помеченные как удаленные или обновленные, что предотвращает разрастание таблицы и индексов.
- **Сбор статистики (ANALYZE)**: Выполняет сбор статистики на основе текущего состояния таблицы, как описано выше.

Использование `VACUUM ANALYZE` часто предпочтительнее, поскольку позволяет убедиться, что статистика собирается по актуальному количеству "живых" строк.



### Автоматическое обновление статистики (`autovacuum`)

Наиболее распространенный и рекомендуемый способ поддержания актуальной статистики — это использование встроенного процесса **`autovacuum`**.
- По умолчанию `autovacuum` **автоматически запускает `ANALYZE`** для таблицы, когда обнаруживает, что было изменено (вставлено/обновлено/удалено) достаточное количество строк. 
- Пороги для автоматического запуска определяются настройками, такими как:
    - **`autovacuum_analyze_threshold`** (минимальное количество измененных строк).
    - **`autovacuum_analyze_scale_factor`** (доля таблицы, которая должна быть изменена).
        

#### Настройка статистики

Вы можете тонко настроить сбор статистики для конкретного столбца с помощью команды `ALTER TABLE`:

```sql
ALTER TABLE users ALTER COLUMN email SET STATISTICS 1000;
```

Где `1000` — это **целевой уровень статистики (statistics target)**. Увеличение этого значения (по умолчанию 100) заставляет `ANALYZE` собирать **более подробную** статистику, особенно о распределении данных, что полезно для столбцов с нерегулярным распределением или сложными запросами. Однако это увеличивает время выполнения `ANALYZE` и объем данных в `pg_statistic`.